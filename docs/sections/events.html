<!-- Events Timeline Section -->
<div class="section-events">
  <header class="section-header">
    <h1>Events & Timeline</h1>
    <p>Chronological view of discoveries and activities</p>
  </header>

  <div class="section-container">
    <!-- Filters -->
    <div id="filter-container" class="filter-bar">
      <div class="filter-group">
        <label>Season:</label>
        <select id="season-filter" class="filter-select"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label>Location:</label>
        <select id="location-filter" class="filter-select"><option value="">All</option></select>
      </div>
    </div>

    <!-- Events List -->
    <div id="events-list" class="events-timeline">
      <div class="loading">Loading events...</div>
    </div>
  </div>
</div>

<script>
/**
 * Events timeline renderer
 */
async function renderEvents(container) {
  const html = `<!-- Events Timeline Section -->
<div class="section-events">
  <header class="section-header">
    <h1>Events & Timeline</h1>
    <p>Chronological view of discoveries and activities</p>
  </header>

  <div class="section-container">
    <!-- Filters -->
    <div id="filter-container" class="filter-bar">
      <div class="filter-group">
        <label>Season:</label>
        <select id="season-filter" class="filter-select"><option value="">All</option></select>
      </div>
      <div class="filter-group">
        <label>Location:</label>
        <select id="location-filter" class="filter-select"><option value="">All</option></select>
      </div>
    </div>

    <!-- Events List -->
    <div id="events-list" class="events-timeline">
      <div class="loading">Loading events...</div>
    </div>
  </div>
</div>`;

  container.innerHTML = html;

  let allEvents = [];
  let allLocations = [];

  try {
    // Load events
    const eventsResult = await apiService.getEvents({ limit: 500 });
    if (eventsResult.success && eventsResult.data) {
      allEvents = Array.isArray(eventsResult.data.data) ? eventsResult.data.data : eventsResult.data.events || [];
    }

    // Load locations for filter
    const locsResult = await apiService.getLocations();
    if (locsResult.success && locsResult.data) {
      allLocations = Array.isArray(locsResult.data.data) ? locsResult.data.data : locsResult.data;
    }

    // Populate location filter
    const locFilter = document.getElementById('location-filter');
    allLocations.forEach(loc => {
      const opt = document.createElement('option');
      opt.value = loc.id;
      opt.textContent = loc.name || 'Unknown';
      locFilter.appendChild(opt);
    });

    // Get unique seasons
    const seasons = [...new Set(allEvents.map(e => e.season).filter(s => s))].sort((a, b) => a - b);
    const seasonFilter = document.getElementById('season-filter');
    seasons.forEach(season => {
      const opt = document.createElement('option');
      opt.value = season;
      opt.textContent = `Season ${season}`;
      seasonFilter.appendChild(opt);
    });

    // Display events
    displayEvents(allEvents);

    // Filter handlers
    const updateDisplay = () => {
      const season = document.getElementById('season-filter').value;
      const location = document.getElementById('location-filter').value;

      let filtered = allEvents;
      if (season) filtered = filtered.filter(e => e.season == season);
      if (location) filtered = filtered.filter(e => e.location_id === location);

      displayEvents(filtered);
    };

    document.getElementById('season-filter').addEventListener('change', updateDisplay);
    document.getElementById('location-filter').addEventListener('change', updateDisplay);
  } catch (err) {
    document.getElementById('events-list').innerHTML = UI.renderError(err.message);
  }
}

function displayEvents(events) {
  const sorted = (events || []).sort((a, b) => {
    const dateA = new Date(a.date || a.air_date || 0);
    const dateB = new Date(b.date || b.air_date || 0);
    return dateB - dateA;
  });

  const html = sorted.map(evt => `
    <div class="timeline-event">
      <div class="event-date">${evt.date ? UI.formatDate(evt.date) : 'Unknown'}</div>
      <div class="event-content">
        <h4>${UI.escapeHtml(evt.title || evt.description || 'Event')}</h4>
        ${evt.description ? `<p>${UI.escapeHtml(evt.description)}</p>` : ''}
        ${evt.season ? `<div class="event-meta">Season ${evt.season}</div>` : ''}
      </div>
    </div>
  `).join('');

  document.getElementById('events-list').innerHTML = html || UI.renderEmpty('No events found');
}

// Register route
window.router.register('events', renderEvents);
</script>
